---
title: ボットを Web ブラウザーと統合する - Bot Service
description: ボットから Web ブラウザー、および Web ブラウザーからボットへのスムーズなユーザー切り替えを設計する方法について説明します。
author: matvelloso
ms.author: mateusv
manager: kamrani
ms.topic: article
ms.service: bot-service
ms.date: 12/13/2017
ms.openlocfilehash: 8570873a63a539b4f7c96053aec2ab1a1f615eb9
ms.sourcegitcommit: 9d77f3aff9521d819e88efd0fbd19d469b9919e7
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/16/2020
ms.locfileid: "75792130"
---
# <a name="integrate-your-bot-with-a-web-browser"></a>ボットを Web ブラウザーと統合する

一部のシナリオでは、要件を満たすためにボット以外のものが必要です。 ボットによっては、タスクを完了するためにユーザーを Web ブラウザーに送信し、タスクの完了後に、ユーザーとの会話を再開しなければならないことがあります。 

## <a name="authentication-and-authorization"></a>認証と権限承認
Office 365 でユーザーの予定表を読み取る機能、またはユーザーの代わりに予定を作成する機能がボットに必要な場合は、最初にそのユーザーを Microsoft Azure Active Directory で認証し、ボットがユーザーの予定表のデータにアクセスできるようにしなければなりません。 ユーザーは、タスクの認証と承認を完了するためにボットによって Web ブラウザーにリダイレクトされ、その後、そのユーザーとの会話が再開されます。 

## <a name="security-and-compliance"></a>セキュリティとコンプライアンス
ボットとユーザーの間でやり取りできる情報の種類は、多くの場合、セキュリティとコンプライアンスの要件よって制限されます。 場合によっては、ユーザーが現在の会話の外部でデータを送受信する必要が生じることもあります。 たとえば、ユーザーがサードパーティの支払いプロバイダーを使用して支払いを実行する場合、クレジット カード番号については、会話のコンテキスト内で指定するべきではありません。 この場合、ユーザーは支払いプロセスを完了するためにボットによって Web ブラウザーにリダイレクトされ、その後、そのユーザーとの会話が再開されます。

この記事では、ボットから Web ブラウザー、および Web ブラウザーからボットへのユーザーの移行を円滑に行うためのプロセスについて説明します。 

> [!NOTE]
> チャットから Web ブラウザーおよび Web ブラウザーからチャットへの移行はお勧めしません。アプリケーション間で切り替えを行うと、ユーザーの混乱を招きやすいためです。 より優れたエクスペリエンスを提供するために、多くのチャネルには組み込みの HTML ウィンドウが用意されており、ボットは、このウィンドウを使って Web ブラウザーに表示されるアプリケーションを提供できます。 この手法により、ユーザーは会話から離れずに、外部リソースにアクセスできます。 このアプローチは、概念的には、埋め込みの Web ビューで OAuth を使用して承認フローを管理するモバイル アプリケーションに似ています。

## <a name="bot-to-web-browser-and-back-again"></a>ボットから Web ブラウザー、Web ブラウザーからボット

この図は、ボットと Web ブラウザーの間の統合フローの概要を示しています。 

![ボットと Web のやりとり](~/media/bot-service-design-pattern-integrate-browser/bot-to-web1.png)

このフローの各ステップを見ていきましょう。

1. <a id="generate-hyperlink"></a>ボットによってハイパーリンクが生成および表示されます。このハイパーリンクによって、ユーザーは Web サイトにリダイレクトされます。 
   このハイパーリンクには、通常、チャネル内の会話 ID、チャネル ID、ユーザー ID などの現在の会話のコンテキストに関する情報を指定する、ターゲット URL 上の querystring パラメーター経由のデータが含まれています。 

2. ユーザーがハイパーリンクをクリックします。そのユーザーは、Web ブラウザー内のターゲット URL にリダイレクトされます。 

3. ボットは、Web サイトのフローが完了したことを示す、Web サイトからの通信を待っている状態になります。  
   > [!TIP]
   > このフローは、ユーザーが Web サイトのフローを完了しない場合に、ボットが永久的に "待機" 状態にならないように設計してください。 つまり、ユーザーが Web ブラウザーを破棄して、ボットとの通信を再び開始したときに、ボットではその入力を[無視](~/bot-service-design-navigation.md#the-mysterious-bot)するのではなく、確認しなければなりません。

4. ユーザーは Web ブラウザーを使用して必要なタスクを完了します。 
   これは OAuth フローまたは当面のシナリオに必要なイベントの任意のシーケンスです。 

5. <a id="generate-magic-number"></a>ユーザーが Web サイトのフローを完了すると、Web サイトによって "[マジック ナンバー](#verify-identity)" が生成されます。ユーザーは、Web サイトからこの値をコピーし、ボットとの会話に貼り付けるように指示されます。 

6. <a id="signal-to-bot"></a>ユーザーが Web サイトのフローを完了したことが、Web サイトから[シグナルによってボットに通知](#website-signal-to-bot)されます。 
   ボットには "マジック ナンバー" が伝えられるほか、その他の関連データもすべて提供されます。
   たとえば、OAuth フローの場合、Web サイトからはアクセス トークンがボットに提供されます。

7. ユーザーはボットに戻り、"マジック ナンバー" をチャットに貼り付けます。 
   ユーザーによって提供された "マジック ナンバー" と、予期される値が一致することで、現在のユーザーが、前にハイパーリンクをクリックして Web サイトのフローを開始したユーザーと同じであることが確認されます。 

### <a name="verifying-user-identity-using-the-magic-number"></a><a id="verify-identity"></a> "マジック ナンバー" を使用したユーザー ID の確認

ボットから Web サイトへのフロー中に "マジック ナンバー" が生成されることで (上記の[手順 5](#generate-magic-number))、Web サイトのフローを開始したユーザーが、本当に意図されたユーザーであることを後で確認できます。 たとえば、ボットによって、複数のユーザーが参加しているグループ チャットが実行されている場合に、参加ユーザーの 1 人がハイパーリンクをクリックして Web サイトのフローを開始したとします。 "マジック ナンバー" 検証プロセスがないと、ボットでは、どのユーザーがフローを完了したかを判断できません。 認証された 1 人のユーザーが、別のユーザーのセッションにアクセス トークンを挿入する可能性もあります。 

> [!WARNING] 
> これはグループ チャットだけのリスクではありません。 "マジック ナンバー" 検証プロセスがないと、Web サイトのフローを起動するハイパーリンクを取得するユーザーすべてが、別のユーザーになりすますことができます。 

マジック ナンバーは、強力な暗号化ライブラリを使用して生成されたランダムな数値でなければなりません。 C# での生成プロセスの例については、<a href="https://www.nuget.org/packages/BotAuth" target="_blank">BotAuth</a> ライブラリ内にある<a href="https://github.com/MicrosoftDX/botauth/tree/master/CSharp" target="_blank">こちらのコード</a>を参照してください。 BotAuth を使用することにより、Microsoft Bot Framework に組み込まれているボットは、ボットから Web サイトへのフローを実装して Web サイトでユーザーを認証し、その後、認証プロセスから生成されたアクセス トークンを使用できます。 BotAuth は、チャネルの機能については何の想定も行わないため、このようなフローはほとんどのチャネルで適切に機能します。 

> [!NOTE]
> "マジック ナンバー" 検証プロセスの必要性は、チャネルによって独自の埋め込み Web ビューが構築されているときは非推奨です。

### <a name="how-does-the-website-signal-the-bot"></a><a id="website-signal-to-bot"></a>Web サイトがボットに "シグナル" で通知する方法

ボットによって、ユーザーがクリックして Web サイトのフローを開始する[ハイパーリンクが生成](#generate-hyperlink)されるとき、そのハイパーリンクには、通常、チャネル内の会話 ID、チャネル ID、ユーザー ID などの現在の会話のコンテキストに関する、ターゲット URL 上の querystring パラメーター経由の情報が含まれています。 その後、Web サイトでは、この情報を使って、そのユーザーまたは会話に関する状態変数が、Bot Framework SDK または REST API を使用して読み書きされます。 Web サイトのフローが完了したことを、Web サイトがボットに "シグナル" で通知する方法の例については、上記の[手順 6](#signal-to-bot) を参照してください。

## <a name="sample-code"></a>サンプル コード

<a href="https://github.com/MicrosoftDX/botauth" target="_blank">BotAuth</a> ライブラリを使用すると、この記事の説明に従って、Microsoft Bot Framework で .NET および Node を使用して構築されたボットに OAuth フローをバインドできます。

## <a name="additional-resources"></a>その他のリソース

- [ダイアログ](~/dotnet/bot-builder-dotnet-dialogs.md)
- [ダイアログで会話フローを管理する (.NET)](~/dotnet/bot-builder-dotnet-manage-conversation-flow.md)
- [ダイアログで会話フローを管理する (Node.js)](~/nodejs/bot-builder-nodejs-manage-conversation-flow.md)
