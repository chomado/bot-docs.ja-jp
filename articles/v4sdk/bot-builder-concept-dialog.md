---
title: Bot Framework SDK 内のダイアログ | Microsoft Docs
description: ダイアログとは何か、またダイアログは Bot Framework SDK 内でどのように機能するのかについて説明します。
keywords: 会話フロー, プロンプト, ダイアログの状態, 意図の認識, 1 ターン, 複数ターン, ボットの会話, ダイアログ, プロンプト, ウォーターフォール, ダイアログ セット
author: johnataylor
ms.author: johtaylo
manager: kamrani
ms.topic: article
ms.service: bot-service
ms.subservice: sdk
ms.date: 11/28/2018
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: 31a0497f1422cee8c4966e59d94a89ae359a5cb7
ms.sourcegitcommit: c6ce4c42fc56ce1e12b45358d2c747fb77eb74e2
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/22/2019
ms.locfileid: "54453936"
---
# <a name="dialogs-library"></a>ダイアログ ライブラリ

[!INCLUDE [pre-release-label](../includes/pre-release-label.md)]

"*ダイアログ*" は SDK での中心的な概念であり、ユーザーとの会話の管理に役立つ手段を提供します。 ダイアログは、ボットのプログラムで関数のように動作する、ボット内の構造です。各ダイアログは、特定のタスクを特定の順序で実行するように設計されています。 個々のダイアログの順序を指定して会話を導き、ユーザーへの応答、外部の刺激、他のダイアログからなど、さまざまな方法でダイアログを呼び出すことができます。

ダイアログのライブラリでは、ボットの会話を管理しやすくする、"*プロンプト*" や "*ウォーターフォール ダイアログ*" などの、いくつかの組み込み機能が用意されています。 [プロンプト](#prompts)は、テキスト、数値、日付などのさまざまな種類の情報を要求するために使用します。 [ウォーターフォール ダイアログ](#waterfall-dialogs)では、ある順序でまとめて複数のステップを組み合わせることができます。ボットはその定義済みの順序に簡単に従って、次のステップに情報を渡すことができます。

<!-- When we have samples for building your own, add links and one liner about them -->

## <a name="dialogs-and-their-pieces"></a>ダイアログとその要素

ダイアログのライブラリには、ダイアログをさらに便利にするための追加要素がいくつかあります。 ライブラリには、以下で説明するさまざまな[ダイアログの種類](#dialog-types)のほかにも、"*ダイアログ セット*"、"*ダイアログ コンテキスト*"、および "*ダイアログの結果*" の概念があります。

"*ダイアログ セット*" は、簡単に言えば、ダイアログの集合体です。 プロンプト、ウォーターフォール ダイアログ、[コンポーネント ダイアログ](#component-dialog)などを指定できます。 それぞれが 1 つのダイアログの実装であり、特定の文字列 ID を使用してダイアログ セットに個別に追加されます。 ダイアログ セット内でダイアログまたはプロンプトを開始する場合、どのダイアログを使用するかを指定するために文字列 ID が使用されます。

"*ダイアログ コンテキスト*" には、そのダイアログに関係する情報が含まれ、ボットのターン ハンドラー内からダイアログと対話するために使用されます。 ダイアログ コンテキストには、現在のターン コンテキスト、親ダイアログ、および[ダイアログの状態](#dialog-state)が含まれています。ダイアログの状態が、ダイアログ内の情報を保持する方法を指定します。 ダイアログ コンテキストを使用すると、文字列 ID を使用してダイアログを開始したり、現在のダイアログ (複数のステップが含まれるウォーターフォール ダイアログなど) を続行したりすることができます。

ダイアログの終了時に、"*ダイアログの結果*" とダイアログから結果として得られる情報を返すことができます。 この情報は、必要な場合に、ダイアログ内で何が起こったかを呼び出し元メソッドで確認して、永続的な場所にその情報を保存するために返されます。

## <a name="dialog-state"></a>ダイアログの状態

ダイアログはマルチターンの会話を実装するためのアプローチの 1 つであり、複数のターンにわたって保持された状態に依存する、SDK の機能の一例です。 ダイアログに状態が含まれていないと、ボットでは、ダイアログ セットにおける自身の位置や、自身が既に収集した情報を認識できません。

ダイアログ ベースのボットには、通常、そのボット実装のメンバー変数としてダイアログ セット コレクションが保持されます。 そのダイアログ セットは、保持されている状態へのアクセスを提供する、アクセサーというオブジェクトへのハンドルを使用して作成されます。 ボット内の状態の背景情報については、[状態の管理](bot-builder-concept-state.md)に関するページをご覧ください。

ボットのオン ターン ハンドラー内で、ボットはダイアログ セットで *create context* を呼び出すことにより、ダイアログのサブシステムを初期化します。これにより、"*ダイアログ コンテキスト*" が返されます。 そのダイアログ コンテキストには、ダイアログに必要な情報が含まれています。

ダイアログ コンテキストを作成するには状態が必要です。これには、ダイアログ セットの作成時に指定されたアクセサーを使ってアクセスします。 そのアクセサーを使用すると、ダイアログ セットは、適切なダイアログの状態を取得できます。 状態アクセサーの詳細については、[会話およびユーザー データの保存](bot-builder-howto-v4-state.md)に関するページをご覧ください。

## <a name="dialog-types"></a>ダイアログの種類

ダイアログは、次のクラス階層で示すように、プロンプト、ウォーターフォール ダイアログ、およびコンポーネント ダイアログの数種類で構成されます。

![ダイアログのクラス](media/bot-builder-dialog-classes.png)

### <a name="prompts"></a>プロンプト

プロンプトは、ユーザーに情報を要求して応答を評価するための簡単な方法をダイアログ ライブラリ内で提供します。 たとえば、"*数値プロンプト*" では、質問や要求している情報を指定すると、プロンプトが有効な数値の応答を受信したかどうかが自動的に確認されます。 適切な応答が得られた場合は、会話を継続できます。それ以外の場合は、有効な答えをユーザーに再度要求します。

バックグラウンドでは、プロンプトは 2 つのステップから成るダイアログです。 プロンプトでは、最初のステップで入力を要求し、2 番目のステップで有効な値を返すか、最初からやり直して再度入力を要求します。

プロンプトには、プロンプトの呼び出し時に指定される "*プロンプト オプション*" があり、プロンプトで使用するテキスト、検証に失敗した場合の再試行プロンプト、およびプロンプトに対する回答の選択肢を指定できます。

さらに、プロンプトの作成時に、プロンプト用にいくつかのカスタム検証を追加することができます。 たとえば、数値プロンプトを使用して会合の規模を把握するとします。ただし、その会合の規模は 3 人以上、12 人未満である必要があります。 このプロンプトは、まず、有効な数値を受け取ったかどうかを確認し、カスタム検証が指定されている場合はその後にカスタム検証を実行します。 カスタム検証に失敗した場合、ユーザーは再度上記の内容を要求されます。

プロンプトが完了したら、要求された結果の値が明示的に返されます。 値が返されると、組み込みのプロンプトの検証と、入力された可能性のあるあらゆる追加のカスタム検証の両方を通過したことが保証されます。

さまざまなプロンプトを使用するときの例については、[ユーザー入力を収集するダイアログ ライブラリ](bot-builder-prompts.md)の使用方法を参照してください。

#### <a name="prompt-types"></a>プロンプトの種類

バックグラウンドでは、プロンプトは 2 つのステップから成るダイアログです。 プロンプトでは、最初のステップで入力を要求し、2 番目のステップで有効な値を返すか、最初からやり直して再度入力を要求します。 ダイアログ ライブラリには、多数の基本的なプロンプトが用意されており、それぞれ異なる種類の応答の収集に使用されます。 基本的なプロンプトでは、数を表す "ten" や "a dozen"、日時を表す "tomorrow" や "Friday at 10am" など、自然言語の入力を解釈できます。

| Prompt | 説明 | 戻り値 |
|:----|:----|:----|
| _添付ファイル プロンプト_ | ドキュメントや画像など、1 つ以上の添付ファイルを要求します。 | "_添付ファイル_" オブジェクトのコレクション。 |
| _選択プロンプト_ | 一連のオプションから選択するよう求めます。 | "_見つかった選択肢_" オブジェクト。 |
| _確認プロンプト_ | 確認を求めます。 | ブール値。 |
| _日時プロンプト_ | 日時の入力を求めます。 | "_日時解決_" オブジェクトのコレクション。 |
| _数値プロンプト_ | 数値の入力を求めます。 | 数値。 |
| _テキスト プロンプト_ | 一般的なテキスト入力を求めます。 | 文字列。 |

ユーザーに入力を求めるには、組み込みクラスのいずれかを使用してプロンプト (_"テキスト プロンプト"_ など) を定義し、ダイアログ セットに追加します。 プロンプトには固定 ID があります。この ID は、ダイアログ セット内で一意である必要があります。 プロンプトごとにカスタム検証コントロールを含めることができます。一部のプロンプトについては、"_既定のロケール_" を指定できます。 

#### <a name="prompt-locale"></a>プロンプトのロケール

ロケールは、**選択**、**確認**、**日時**、**数値**の各プロンプトの言語固有の動作を決定するために使用されます。 ユーザーからの任意の入力に対して、チャネルがユーザーのメッセージで _locale_ プロパティを提供した場合は、このロケールが使用されます。 それ以外の場合、プロンプトのコンストラクターの呼び出し時に指定するか、後で設定することによって、プロンプトの "_既定のロケール_" が設定されていれば、それが使用されます。 どちらも指定されていない場合は、ロケールとして英語 ("en-us") が使用されます。 注:ロケールは、言語または言語ファミリを表す 2、3、または 4 文字の ISO 639 コードです。

### <a name="waterfall-dialogs"></a>ウォーターフォール ダイアログ

ウォーターフォール ダイアログはダイアログ特有の実装であり、一般的にユーザーから情報を収集したり、一連のタスクをユーザーに案内したりするときに使用されます。 会話の各ステップは、"*ウォーターフォール ステップ コンテキスト*" (`step`) パラメーターを取得する非同期関数として実装されます。 各ステップで、ボットは、[ユーザーに入力を要求するプロンプトを表示](bot-builder-prompts.md)し (または、子ダイアログを開始できるが、プロンプトであることが多い)、応答を待ち、結果を次のステップに渡します。 最初の関数の結果は次の関数の引数として渡され、その次の関数でも同様です。

次の図は、ウォーターフォール ステップの順序と、実行されるスタック操作を示したものです。 ダイアログ スタックの使用方法の詳細は、下の「[ダイアログの使用](#using-dialogs)」セクションに記載されています。

![ダイアログの概念](media/bot-builder-dialog-concept.png)

ウォーターフォール ステップ内で、ウォーターフォール ダイアログのコンテキストは、"*ウォーターフォール ステップ コンテキスト*" に格納されます。 これによって、現在のターン コンテキストと状態にアクセスできるため、このコンテキストはダイアログ コンテキストに似ています。 ウォーターフォール ステップ コンテキスト オブジェクトを使用して、ウォーターフォール ステップ内からダイアログ セットと対話します。

通常、ボットのターン ロジックからのダイアログ ターンの結果の状態のみを確認する必要がある場合であっても、ダイアログのウォーターフォール ステップ内からの戻り値や、ボットのオン ターン ハンドラーのダイアログからの戻り値を処理することができます。
ウォーターフォール ステップ内では、ウォーターフォール ステップ コンテキストの _result_ プロパティに戻り値が返されます。

#### <a name="waterfall-step-context-properties"></a>ウォーターフォール ステップ コンテキスト プロパティ

ウォーターフォール ステップ コンテキストには、次の要素が含まれます。

* *オプション*: ダイアログの入力情報が格納されます。
* *値*: コンテキストに追加できる情報が格納され、以降の手順に繰り越されます。
* *結果*: 前の手順の結果が格納されます。

さらに、*next* メソッドは、同じターン内のウォーターフォール ダイアログの次のステップに進み、必要な場合は特定のステップをスキップすることができます。

### <a name="component-dialog"></a>コンポーネント ダイアログ

郵便番号、市区町村、および番地の値を指定するようユーザーに要求する住所用のダイアログなど、さまざまなシナリオで使用する再利用可能なダイアログの作成が必要になる場合があります。

"*コンポーネント ダイアログ*" は、特定のシナリオを処理するために、大規模なダイアログ セットをより管理しやすい要素に分割した、独立したダイアログを作成するための戦略を提供します。 各要素には独自のダイアログ セットがあり、その要素を含むダイアログ セットとの名前の競合を回避しています。 これらの詳細については、[コンポーネント ダイアログの使用方法](bot-builder-compositcontrol.md)に関するページを参照してください。

## <a name="using-dialogs"></a>ダイアログの使用

ダイアログ コンテキストを使用して、ダイアログを開始、続行、置換、または終了することができます。 ダイアログ スタック上のすべてのダイアログを取り消すこともできます。

ダイアログは、"*ダイアログ スタック*" と呼ばれるプログラム スタックとして考えることができます。ターン ハンドラーは、ダイアログを振り向け、スタックが空の場合はフォールバックとして機能します。 そのスタックの最上位の項目は "*アクティブなダイアログ*" と見なされ、すべての入力がダイアログ コンテキストからアクティブなダイアログに送信されます。

ダイアログは、開始されると、スタックにプッシュされて、アクティブなダイアログになります。 終了するか、[replace dialog](#repeating-a-dialog) メソッドによって削除されるまではアクティブなダイアログのままであり、別のダイアログが (ターン ハンドラーかアクティブなダイアログ自体のいずれかによって) スタックにプッシュされると、この別のダイアログがアクティブなダイアログになります。 この新しいダイアログが終了すると、スタックから取り除かれます。この場合も、下にある次のダイアログがアクティブなダイアログになります。 これにより、後述する[分岐構造とループ](#looping-and-branching)が可能になります。

### <a name="create-the-dialog-context"></a>ダイアログのコンテキストを作成する

ダイアログ コンテキストを作成するには、ダイアログ セットの *create context* メソッドを呼び出します。 create context では、ダイアログ セットの "*ダイアログの状態*" プロパティを取得して、ダイアログ コンテキストの作成に使用します。 ダイアログ コンテキストは、起動、続行に使用されるか、それ以外の場合は、ダイアログ セット内のダイアログの制御に使用されます。

ダイアログ セットでは、ダイアログの状態にアクセスするために、"*状態プロパティ アクセサー*" が必要です。 このアクセサーは、その他の状態のアクセサーと同じ方法で作成および使用されますが、会話の状態に基づいて独自のプロパティとして作成されます。 状態の管理方法の詳細については、[状態の管理に関するトピック](bot-builder-concept-state.md)に記載され、ダイアログの状態の使用状況については、[連続して行われる会話フロー](bot-builder-dialog-manage-conversation-flow.md)の仕組みに関するページに記載されています。

### <a name="to-start-a-dialog"></a>ダイアログを開始するには

ダイアログを開始するには、開始する "*ダイアログ ID*" を、ダイアログ コンテキストの *begin dialog*、*prompt*、または *replace dialog* メソッドに渡します。

* begin dialog メソッドは、スタックの一番上にダイアログをプッシュします。
* replace dialog メソッドは、現在のダイアログをスタックから取り除き、それに置き換わるダイアログをスタックにプッシュします。 置き換えられたダイアログは取り消され、そのインスタンスに含まれているすべての情報が破棄されます。

_options_ パラメーターを使用して、ダイアログの新しいインスタンスに情報を渡します。
新しいダイアログに渡されたオプションには、ダイアログの任意のステップで、ステップ コンテキストの *options* プロパティを通じてアクセスできます。
コード例の使用方法については、「[ブランチとループを使用して高度な会話フローを作成する](bot-builder-dialog-manage-complex-conversation-flow.md)」を参照してください。

### <a name="to-continue-a-dialog"></a>ダイアログを続行するには

ダイアログを続行するには、*continue dialog* メソッドを呼び出します。 continue dialog メソッドでは、常に、スタックの最上位のダイアログ (アクティブなダイアログ) を続行します (存在する場合)。 続行したダイアログが終了する場合は、同じターン内の続行する親コンテキストに制御が渡されます。

ターン間の状態を保持するには、ステップ コンテキストの *values* プロパティを使用します。
先行ターンでこのコレクションに追加された値はすべて、後続のターンで利用できます。
コード例の使用方法については、「[ブランチとループを使用して高度な会話フローを作成する](bot-builder-dialog-manage-complex-conversation-flow.md)」を参照してください。

### <a name="to-end-a-dialog"></a>ダイアログを終了するには

*end dialog* メソッドは、スタックからダイアログを取り出し、親コンテキスト (呼び出し元のダイアログやボットのターン ハンドラーなど) に省略可能な結果を返してダイアログを終了します。 ほとんどの場合は、ダイアログ自体の現在のインスタンスを終了するために、ダイアログ内から呼び出します。

end dialog メソッドは、ダイアログ コンテキストのある任意の場所から呼び出すことができますが、ボットには、現在のアクティブなダイアログから呼び出されたように見えます。

> [!TIP]
> *end dialog* メソッドはダイアログの最後に明示的に呼び出すことをお勧めします。

### <a name="to-clear-all-dialogs"></a>すべてのダイアログをクリアするには

スタックからすべてのダイアログを取り出す場合は、ダイアログ コンテキストの *cancel all dialogs* メソッドを呼び出すことで、ダイアログ スタックをクリアできます。

### <a name="repeating-a-dialog"></a>ダイアログの繰り返し

ダイアログをそれ自体と置き換えることで、ループを作成できます。
この手法は、[複雑な会話フロー](~/v4sdk/bot-builder-dialog-manage-complex-conversation-flow.md)を処理する優れた方法であり、メニューを管理する優れた手法でもあります。

> [!NOTE]
> 現在のダイアログ ボックスの内部状態を維持する必要がある場合は、*replace dialog* メソッドへの呼び出しで、ダイアログの新しいインスタンスに情報を渡した後、ダイアログを適切に初期化する必要があります。

### <a name="branch-a-conversation"></a>会話の分岐

ダイアログ コンテキストではダイアログ スタックが保持され、スタックのダイアログごとに、次のステップが追跡されます。 *begin dialog* メソッドは、子ダイアログを作成してスタックの一番上にプッシュし、*end dialog* メソッドは一番上のダイアログをスタックから取り除きます。 *end dialog* は、通常、終了するダイアログ内から呼び出されます。

ダイアログでは、ダイアログ コンテキストの *begin dialog* メソッドを呼び出し、新しいダイアログの ID を指定することで、同じダイアログ セット内で新しいダイアログを開始できます。これにより、新しいダイアログがアクティブ ダイアログになります。 元のダイアログは引き続きスタック上に残りますが、ダイアログ コンテキストの *continue dialog* メソッドへの呼び出しは、スタックの一番上のダイアログ ("*アクティブ ダイアログ*") にのみ送信されます。 ダイアログがスタックから取り除かれると、ダイアログ コンテキストは、スタックのウォーターフォールの次のステップに移り、元のダイアログが中断されたところから再開されます。

つまり、会話フロー内に分岐を作成するには、ダイアログにステップを追加して、利用可能な一連のダイアログの中から、開始するダイアログを条件に応じて選択できるようにします。

## <a name="next-steps"></a>次の手順

> [!div class="nextstepaction"]
> [ユーザー入力を収集するためにダイアログ ライブラリを使用する](bot-builder-prompts.md)
